<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visor GIS (OSM + Satélite + KMZ + WMS)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- KMZ: unzip + KML->GeoJSON -->
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/@tmcw/togeojson@6.0.1/dist/togeojson.umd.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { height: 100%; }
    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 12px; border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15); width: 340px;
    }
    .panel h3 { margin: 0 0 8px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 10px; }
    input, button, select { width: 100%; padding: 8px; border-radius: 10px; border: 1px solid #ddd; }
    button { cursor: pointer; border: 0; background: #111; color: #fff; }
    button.secondary { background: #f3f3f3; color: #111; border: 1px solid #ddd; }
    .small { font-size: 12px; opacity: 0.8; line-height: 1.2; }
    .chip { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #efefef; font-size: 12px; margin-right: 6px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Visor GIS</h3>
    <div class="small">
      <span class="chip">OSM</span>
      <span class="chip">Satélite</span>
      <span class="chip">KMZ</span>
      <span class="chip">WMS</span>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:10px 0;"/>

    <div class="row">
      <label class="small"><b>Importar KMZ</b> (KML comprimido)</label>
      <input id="kmzInput" type="file" accept=".kmz" />
      <button id="btnClearKmz" class="secondary">Quitar capas KMZ</button>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:10px 0;"/>

    <div class="row">
      <label class="small"><b>Añadir WMS</b> (OGC Web Map Service)</label>
      <select id="preset">
        <option value="">— Presets (España) —</option>
        <option value="https://www.ign.es/wms-inspire/ign-base|IGNBase (WMS)|IGNBaseTodo">IGNBase (mapa base)</option>
        <option value="https://www.ign.es/wms-inspire/pnoa-ma|PNOA Máxima Actualidad (WMS)|OI.OrthoimageCoverage">PNOA máx. actualidad</option>
        <option value="http://ovc.catastro.meh.es/cartografia/INSPIRE/spadgcwms.aspx|Catastro INSPIRE (WMS)|CP.CadastralParcel">Catastro INSPIRE</option>
      </select>

      <input id="wmsUrl" placeholder="URL WMS (ej: https://.../wms)" />
      <input id="wmsLayers" placeholder="LAYERS (coma-separado) (ej: IGNBaseTodo)" />
      <input id="wmsName" placeholder="Nombre de la capa (ej: IGN Base)" />

      <button id="btnAddWms">Añadir WMS</button>
      <button id="btnClearWms" class="secondary">Quitar capas WMS</button>

      <div class="small">
        Tip: si el WMS es INSPIRE, suele requerir <code>transparent=true</code> y <code>format=image/png</code>.
      </div>
    </div>
  </div>

  <script>
    // ======= MAPA BASE =======
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors'
    });

    // Satélite (Esri World Imagery). Nota: no es OSM, pero es gratuito de uso general en muchos visores.
    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 20, attribution: 'Tiles &copy; Esri' }
    );

    const map = L.map('map', { layers: [osm] }).setView([40.4168, -3.7038], 6);

    const baseLayers = { "OpenStreetMap": osm, "Satélite": esriSat };
    const overlayLayers = {};
    const control = L.control.layers(baseLayers, overlayLayers, { collapsed: true }).addTo(map);

    // ======= GRUPOS DE CAPAS =======
    const kmzGroup = L.featureGroup().addTo(map);
    const wmsGroup = L.layerGroup().addTo(map);

    // Para que aparezcan en el selector
    control.addOverlay(kmzGroup, "KMZ importados");
    control.addOverlay(wmsGroup, "WMS añadidos");

    // ======= UTIL: añadir GeoJSON con estilo básico =======
    function addGeoJsonToKmzGroup(geojson, name) {
      const layer = L.geoJSON(geojson, {
        style: () => ({ weight: 3, fillOpacity: 0.2 }),
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 6, fillOpacity: 0.8 })
      });

      layer.bindPopup((f) => {
        const props = f.feature?.properties || {};
        const rows = Object.entries(props)
          .slice(0, 20)
          .map(([k,v]) => `<div><b>${k}</b>: ${String(v)}</div>`)
          .join('');
        return `<div style="max-width:260px">${rows || 'Sin atributos'}</div>`;
      });

      layer.addTo(kmzGroup);
      if (name) control.addOverlay(layer, `KMZ: ${name}`);
      try { map.fitBounds(layer.getBounds(), { padding: [20,20] }); } catch {}
    }

    // ======= KMZ IMPORT =======
    async function loadKmz(file) {
      const buf = await file.arrayBuffer();
      const zip = await JSZip.loadAsync(buf);

      // Encuentra el primer .kml dentro del KMZ
      let kmlFile = null;
      zip.forEach((path, entry) => {
        if (!kmlFile && path.toLowerCase().endsWith('.kml')) kmlFile = entry;
      });
      if (!kmlFile) throw new Error("No se encontró ningún .kml dentro del KMZ.");

      const kmlText = await kmlFile.async('text');
      const dom = new DOMParser().parseFromString(kmlText, 'text/xml');
      const geojson = toGeoJSON.kml(dom);

      addGeoJsonToKmzGroup(geojson, file.name);
    }

    document.getElementById('kmzInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        await loadKmz(file);
      } catch (err) {
        alert("Error importando KMZ: " + (err?.message || err));
      } finally {
        e.target.value = "";
      }
    });

    document.getElementById('btnClearKmz').addEventListener('click', () => {
      kmzGroup.clearLayers();
      // Nota: el control de capas mantendrá entradas viejas si añadiste overlays individuales.
      // Para un MVP, vale. Si lo quieres “perfecto”, lo limpiamos con un control custom.
    });

    // ======= WMS =======
    function addWmsLayer(url, layers, name) {
      const wms = L.tileLayer.wms(url, {
        layers,
        format: 'image/png',
        transparent: true,
        version: '1.3.0',
        attribution: ''
      });
      wms.addTo(wmsGroup);
      if (name) control.addOverlay(wms, `WMS: ${name}`);
    }

    document.getElementById('btnAddWms').addEventListener('click', () => {
      const url = document.getElementById('wmsUrl').value.trim();
      const layers = document.getElementById('wmsLayers').value.trim();
      const name = document.getElementById('wmsName').value.trim() || layers;

      if (!url || !layers) return alert("Rellena URL WMS y LAYERS.");
      addWmsLayer(url, layers, name);
    });

    document.getElementById('btnClearWms').addEventListener('click', () => {
      wmsGroup.clearLayers();
    });

    // Presets
    document.getElementById('preset').addEventListener('change', (e) => {
      const v = e.target.value;
      if (!v) return;
      const [url, name, layers] = v.split('|');
      document.getElementById('wmsUrl').value = url;
      document.getElementById('wmsName').value = name;
      document.getElementById('wmsLayers').value = layers;
    });
  </script>
</body>
</html>
